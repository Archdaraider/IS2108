{% extends "adminpanel/base.html" %}
{% load static %}

{% block title %}Catalogue - Storefront Visibility{% endblock %}

{% block content %}
<main class="dashboard-main-content">
    
    <!-- Header with Statistics -->
    <div class="content-panel" style="margin-bottom: 1.5rem;">
        <div class="content-panel-header">
            <h2>Product Catalogue</h2>
            <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                Manage which products are visible on the customer storefront
            </p>
        </div>
        <div class="content-panel-body">
            <div style="display: flex; gap: 2rem; flex-wrap: wrap; padding: 1rem 0;">
                <div>
                    <span style="font-size: 0.9rem; color: #777;">Total Products:</span>
                    <span style="font-weight: 600; margin-left: 0.5rem; font-size: 1.1rem;">{{ total_products }}</span>
                </div>
                <div>
                    <span style="font-size: 0.9rem; color: #28a745;">Active:</span>
                    <span style="font-weight: 600; margin-left: 0.5rem; font-size: 1.1rem; color: #28a745;">{{ active_products }}</span>
                </div>
                <div>
                    <span style="font-size: 0.9rem; color: #dc3545;">Hidden:</span>
                    <span style="font-weight: 600; margin-left: 0.5rem; font-size: 1.1rem; color: #dc3545;">{{ inactive_products }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="content-panel" style="margin-bottom: 1.5rem;">
        <div class="content-panel-body">
            <form method="get" action="{% url 'catalogue_view' %}" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
                <!-- Search -->
                <div style="flex: 1; min-width: 200px;">
                    <label for="search" style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: #555;">Search</label>
                    <input type="text" 
                           id="search" 
                           name="search" 
                           value="{{ search_query }}" 
                           placeholder="Search by name, SKU..." 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <!-- Category Filter -->
                <div style="min-width: 180px;">
                    <label for="category" style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: #555;">Category</label>
                    <select id="category" 
                            name="category" 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">All Categories</option>
                        {% for cat in categories %}
                            <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Status Filter -->
                <div style="min-width: 150px;">
                    <label for="status" style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: #555;">Status</label>
                    <select id="status" 
                            name="status" 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">All</option>
                        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Hidden</option>
                    </select>
                </div>

                <!-- Submit Button -->
                <div>
                    <button type="submit" class="btn-primary" style="padding: 0.5rem 1.5rem;">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                </div>

                <!-- Reset Button -->
                <div>
                    <a href="{% url 'catalogue_view' %}" class="btn-secondary" style="padding: 0.5rem 1.5rem; text-decoration: none;">
                        <i class="fas fa-times"></i> Clear
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="content-panel" style="margin-bottom: 1.5rem; background: #f8f9fa;">
        <div class="content-panel-body" style="padding: 1rem;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <div>
                    <input type="checkbox" id="select-all" style="margin-right: 0.5rem;">
                    <label for="select-all" style="font-weight: 600; cursor: pointer;">Select All</label>
                </div>
                <div style="margin-left: auto; display: flex; gap: 0.5rem;">
                    <button type="button" id="bulk-activate" class="btn-secondary" style="background: #28a745; border-color: #28a745; color: white;">
                        <i class="fas fa-eye"></i> Show Selected
                    </button>
                    <button type="button" id="bulk-deactivate" class="btn-secondary" style="background: #dc3545; border-color: #dc3545; color: white;">
                        <i class="fas fa-eye-slash"></i> Hide Selected
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="content-panel">
        <div class="content-panel-body" style="padding: 1.5rem;">
            {% if products %}
                <div class="catalogue-grid">
                    {% for product in products %}
                        <div class="catalogue-card {% if not product.is_active %}inactive{% endif %}" data-product-id="{{ product.pk }}">
                            <!-- Checkbox for bulk selection -->
                            <div class="catalogue-card-checkbox">
                                <input type="checkbox" class="product-checkbox" value="{{ product.pk }}">
                            </div>

                            <!-- Product Image -->
                            <div class="catalogue-card-image">
                                {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy">
                                {% else %}
                                    <div class="no-image-placeholder">
                                        <i class="fas fa-image" style="font-size: 2rem; color: #ccc;"></i>
                                    </div>
                                {% endif %}
                                {% if not product.is_active %}
                                    <div class="hidden-overlay">
                                        <span>HIDDEN</span>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Product Info -->
                            <div class="catalogue-card-content">
                                <h3 class="catalogue-card-title">{{ product.name }}</h3>
                                <p class="catalogue-card-sku">SKU: {{ product.sku }}</p>
                                <p class="catalogue-card-category">{{ product.category }} - {{ product.subcategory }}</p>
                                <p class="catalogue-card-price">${{ product.price|floatformat:2 }}</p>
                                
                                <!-- Toggle Switch -->
                                <div class="catalogue-card-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" 
                                               class="visibility-toggle" 
                                               data-product-id="{{ product.pk }}"
                                               {% if product.is_active %}checked{% endif %}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">
                                        {% if product.is_active %}
                                            <span style="color: #28a745;">Visible</span>
                                        {% else %}
                                            <span style="color: #dc3545;">Hidden</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 3rem; color: #777;">
                    <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <p style="font-size: 1.1rem;">No products found.</p>
                    {% if search_query or category_filter or status_filter %}
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Try adjusting your filters.</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</main>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<style>
    .catalogue-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
    }

    .catalogue-card {
        position: relative;
        background: white;
        border: 2px solid #e8e8ea;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .catalogue-card:hover {
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .catalogue-card.inactive {
        opacity: 0.7;
        border-color: #dc3545;
    }

    .catalogue-card-checkbox {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: white;
        border-radius: 4px;
        padding: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .catalogue-card-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .catalogue-card-image {
        position: relative;
        width: 100%;
        height: 200px;
        background: #f8f9fa;
        overflow: hidden;
    }

    .catalogue-card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .no-image-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
    }

    .hidden-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(220, 53, 69, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .catalogue-card-content {
        padding: 1rem;
    }

    .catalogue-card-title {
        font-size: 1rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        color: #333;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .catalogue-card-sku {
        font-size: 0.85rem;
        color: #666;
        margin: 0 0 0.25rem 0;
    }

    .catalogue-card-category {
        font-size: 0.85rem;
        color: #888;
        margin: 0 0 0.5rem 0;
    }

    .catalogue-card-price {
        font-size: 1.1rem;
        font-weight: 600;
        color: #007bff;
        margin: 0 0 1rem 0;
    }

    .catalogue-card-toggle {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e8e8ea;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
        background-color: #28a745;
    }

    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    .toggle-switch input:disabled + .toggle-slider {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .toggle-label {
        font-size: 0.9rem;
        font-weight: 500;
    }

    .toast {
        visibility: hidden;
        min-width: 250px;
        margin-left: -125px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 16px;
        position: fixed;
        z-index: 1000;
        left: 50%;
        bottom: 30px;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: visibility 0s, opacity 0.3s;
        opacity: 0;
    }

    .toast.show {
        visibility: visible;
        opacity: 1;
    }

    .toast.success {
        background-color: #28a745;
    }

    .toast.error {
        background-color: #dc3545;
    }

    @media (max-width: 768px) {
        .catalogue-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token from cookies (Django's default)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrfToken = getCookie('csrftoken');
    
    // Toast notification function
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast ' + type + ' show';
        
        setTimeout(function() {
            toast.classList.remove('show');
        }, 3000);
    }

    // Toggle individual product visibility
    document.querySelectorAll('.visibility-toggle').forEach(function(toggle) {
        toggle.addEventListener('change', function() {
            const productId = this.dataset.productId;
            const card = this.closest('.catalogue-card');
            const toggleLabel = card.querySelector('.toggle-label span');
            const originalChecked = this.checked;
            
            // Disable toggle during request
            this.disabled = true;
            
            // Make AJAX request
            fetch(`/adminpanel/catalogue/${productId}/toggle/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI
                    if (data.is_active) {
                        card.classList.remove('inactive');
                        card.querySelector('.hidden-overlay')?.remove();
                        toggleLabel.textContent = 'Visible';
                        toggleLabel.style.color = '#28a745';
                    } else {
                        card.classList.add('inactive');
                        const imageDiv = card.querySelector('.catalogue-card-image');
                        if (!imageDiv.querySelector('.hidden-overlay')) {
                            const overlay = document.createElement('div');
                            overlay.className = 'hidden-overlay';
                            overlay.innerHTML = '<span>HIDDEN</span>';
                            imageDiv.appendChild(overlay);
                        }
                        toggleLabel.textContent = 'Hidden';
                        toggleLabel.style.color = '#dc3545';
                    }
                    showToast(data.message, 'success');
                } else {
                    // Revert toggle on error
                    this.checked = !originalChecked;
                    showToast('Error: ' + (data.error || 'Failed to update product'), 'error');
                }
            })
            .catch(error => {
                // Revert toggle on error
                this.checked = !originalChecked;
                showToast('Error: Failed to update product', 'error');
                console.error('Error:', error);
            })
            .finally(() => {
                this.disabled = false;
            });
        });
    });

    // Select all checkbox
    const selectAll = document.getElementById('select-all');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            productCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }

    // Bulk activate/deactivate
    function bulkUpdate(action) {
        const selectedIds = Array.from(document.querySelectorAll('.product-checkbox:checked'))
            .map(checkbox => checkbox.value);
        
        if (selectedIds.length === 0) {
            showToast('Please select at least one product', 'error');
            return;
        }

        if (!confirm(`Are you sure you want to ${action === 'activate' ? 'show' : 'hide'} ${selectedIds.length} product(s)?`)) {
            return;
        }

        // Disable buttons during request
        document.getElementById('bulk-activate').disabled = true;
        document.getElementById('bulk-deactivate').disabled = true;

        const formData = new FormData();
        formData.append('action', action);
        selectedIds.forEach(id => formData.append('product_ids', id));

        fetch('{% url "catalogue_bulk_update" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                // Reload page to reflect changes
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('Error: ' + (data.error || 'Failed to update products'), 'error');
            }
        })
        .catch(error => {
            showToast('Error: Failed to update products', 'error');
            console.error('Error:', error);
        })
        .finally(() => {
            document.getElementById('bulk-activate').disabled = false;
            document.getElementById('bulk-deactivate').disabled = false;
        });
    }

    document.getElementById('bulk-activate')?.addEventListener('click', () => bulkUpdate('activate'));
    document.getElementById('bulk-deactivate')?.addEventListener('click', () => bulkUpdate('deactivate'));
});
</script>

{% endblock content %}

